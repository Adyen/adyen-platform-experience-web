name: Generate SRI Hashes

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.1)'
        required: true
        type: string

permissions:
  contents: read

env:
  BASE_URL: "https://bae81f955b.cdn.adyen.com/platform-components"

jobs:
  generate-sri:
    runs-on: ubuntu-latest
    steps:
      - name: Generate SRI Hashes
        run: |
          VERSION="${{ inputs.version }}"
          
          JS_URL="${BASE_URL}/${VERSION}/adyen-platform-experience-web.js"
          CSS_URL="${BASE_URL}/${VERSION}/adyen-platform-experience-web.css"
          
          echo "Fetching JavaScript file..."
          JS_HASH=$(curl -s "$JS_URL" | openssl dgst -sha384 -binary | openssl base64 -A)
          
          echo "Fetching CSS file..."
          CSS_HASH=$(curl -s "$CSS_URL" | openssl dgst -sha384 -binary | openssl base64 -A)
          
          # Print to logs
          echo "================================"
          echo "Version: ${VERSION}"
          echo "JS Hash: sha384-${JS_HASH}"
          echo "CSS Hash: sha384-${CSS_HASH}"
          echo "================================"
          
          # Add to job summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## 🔐 SRI Hashes for Version ${VERSION}
          
          ### JavaScript
          **URL:** \`${JS_URL}\`
          
          **Integrity Hash:** \`sha384-${JS_HASH}\`
          
          \`\`\`html
          <script src="${JS_URL}"
                  integrity="sha384-${JS_HASH}"
                  crossorigin="anonymous"></script>
          \`\`\`
          
          ### CSS
          **URL:** \`${CSS_URL}\`
          
          **Integrity Hash:** \`sha384-${CSS_HASH}\`
          
          \`\`\`html
          <link href="${CSS_URL}"
                rel="stylesheet"
                integrity="sha384-${CSS_HASH}"
                crossorigin="anonymous">
          \`\`\`
          
          ---
          
          ### 📋 Complete Integration
          \`\`\`html
          <!-- Adyen Platform Experience Web ${VERSION} -->
          <link href="${CSS_URL}"
                rel="stylesheet"
                integrity="sha384-${CSS_HASH}"
                crossorigin="anonymous">
          
          <script src="${JS_URL}"
                  integrity="sha384-${JS_HASH}"
                  crossorigin="anonymous"></script>
          \`\`\`
          EOF